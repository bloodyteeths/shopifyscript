import{a as q}from"/assets/_shared/chunk-XT2LVRN2.js";import{c as A,d as T,f as E,h as m,m as N,o as I}from"/assets/_shared/chunk-XSX5DAMU.js";import{a as M,b as S}from"/assets/_shared/chunk-E6CPWDOJ.js";import{c as g}from"/assets/_shared/chunk-F3TRQT5X.js";var n=g(M()),D=g(q());var e=g(S());function z({data:r}){return r?.length?(0,e.jsxs)("div",{style:{height:180,border:"1px solid #eee",borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",color:"#666"},children:["Chart: ",r.length," points"]}):(0,e.jsx)("div",{style:{height:180,border:"1px solid #eee",borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",color:"#666"},children:"No data"})}var v=class extends n.Component{constructor(o){super(o),this.state={hasError:!1}}static getDerivedStateFromError(o){return{hasError:!0,error:o}}componentDidCatch(o,p){console.error("Insights page error:",o,p)}render(){return this.state.hasError?(0,e.jsxs)("div",{style:{padding:20,border:"1px solid #f56565",borderRadius:8,backgroundColor:"#fed7d7"},children:[(0,e.jsx)("h2",{children:"Something went wrong"}),(0,e.jsx)("p",{children:"The insights page encountered an error. Please refresh the page."}),(0,e.jsx)("button",{onClick:()=>window.location.reload(),style:{marginTop:10,padding:"8px 16px"},children:"Refresh Page"})]}):this.props.children}};function U(){let r=N(),[o]=E(),p=A(),j=I(),w=T(),[l,u]=n.useState(""),[h,x]=n.useState(!1),d=n.useMemo(()=>{try{return o.get("w")==="24h"?"24h":r?.w||"7d"}catch{return"7d"}},[o,r]),a=n.useMemo(()=>r?.kpi||{clicks:0,cost:0,conversions:0,impressions:0,ctr:0,cpc:0,cpa:0},[r]),k=n.useMemo(()=>Array.isArray(r?.top_terms)?r.top_terms:[],[r]),F=n.useMemo(()=>Array.isArray(r?.series)?r.series:[],[r]),C=n.useMemo(()=>Array.isArray(r?.explain)?r.explain:[],[r]),R=n.useMemo(()=>Array.isArray(r?.logs)?r.logs:[],[r]),_=n.useCallback(async(t,s)=>{if(!h){x(!0);try{let{backendFetch:c}=await import("/assets/_shared/hmac-IRSAAKZ4.js"),f={nonce:Date.now(),actions:[]};if(t==="add_exact_negative"&&s)f.actions.push({type:"add_exact_negative",target:s});else if(t==="lower_cpc_ceiling"){let b=Number(a?.cpc||0),P=Math.max(0,isFinite(b)&&b>0?b*.8:.15);f.actions.push({type:"lower_cpc_ceiling",campaign:"*",amount:Number(P.toFixed(2))})}else{u("Invalid action");return}let L=await c("/insights/actions/apply","POST",f);u(L?.json?.ok?"Action applied":"Action failed"),w.revalidate()}catch(c){console.error("Error applying action:",c),u("Action failed - network error")}finally{x(!1)}}},[h,a,w]);return n.useEffect(()=>{if(l){let t=setTimeout(()=>u(""),3e3);return()=>clearTimeout(t)}},[l]),(0,e.jsxs)("div",{children:[(0,e.jsxs)("h1",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,e.jsx)("span",{children:"Insights"}),(0,e.jsxs)("span",{style:{display:"inline-flex",gap:8},children:[(0,e.jsx)(m,{to:"/app/insights?w=7d",children:(0,e.jsx)("button",{disabled:d==="7d"||p.state!=="idle",children:"7d"})}),(0,e.jsx)(m,{to:"/app/insights?w=24h",children:(0,e.jsx)("button",{disabled:d==="24h"||p.state!=="idle",children:"24h"})})]})]}),(0,e.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,minmax(0,1fr))",gap:12},children:[(0,e.jsx)(i,{label:"Clicks",value:a.clicks}),(0,e.jsx)(i,{label:"Cost",value:y(a.cost)}),(0,e.jsx)(i,{label:"Conv.",value:a.conversions}),(0,e.jsx)(i,{label:"Impr.",value:a.impressions}),(0,e.jsx)(i,{label:"CTR",value:G(a.ctr)}),(0,e.jsx)(i,{label:"CPC",value:y(a.cpc)}),(0,e.jsx)(i,{label:"CPA",value:y(a.cpa)})]}),(0,e.jsxs)("h3",{style:{marginTop:16},children:["Trend (",d,")"]}),(0,e.jsx)(z,{data:F}),(0,e.jsxs)("h3",{style:{marginTop:16,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,e.jsxs)("span",{children:["Top search terms (",d,")"]}),(0,e.jsx)(m,{to:`/app/insights/terms?w=${d}`,children:(0,e.jsx)("button",{children:"View all terms"})})]}),(0,e.jsx)("h3",{style:{marginTop:16},children:"Activity (last 10)"}),(0,e.jsxs)("ul",{children:[R.map((t,s)=>!t||typeof t!="object"?null:(0,e.jsxs)("li",{children:[(0,e.jsx)("code",{children:t.timestamp||"No timestamp"})," \u2014"," ",t.message||"No message"]},`log-${s}-${t.timestamp||s}`)),!R.length&&(0,e.jsx)("li",{children:"No recent activity."})]}),(0,e.jsxs)("table",{cellPadding:6,style:{width:"100%",borderCollapse:"collapse"},children:[(0,e.jsx)("thead",{children:(0,e.jsxs)("tr",{children:[(0,e.jsx)("th",{align:"left",children:"Term"}),(0,e.jsx)("th",{align:"right",children:"Clicks"}),(0,e.jsx)("th",{align:"right",children:"Cost"}),(0,e.jsx)("th",{align:"right",children:"Conv."})]})}),(0,e.jsxs)("tbody",{children:[k.map((t,s)=>!t||typeof t!="object"?null:(0,e.jsxs)("tr",{children:[(0,e.jsx)("td",{children:t.term||"Unknown term"}),(0,e.jsx)("td",{align:"right",children:t.clicks||0}),(0,e.jsx)("td",{align:"right",children:y(t.cost)}),(0,e.jsx)("td",{align:"right",children:t.conversions||0})]},`term-${s}-${t.term||s}`)),!k.length&&(0,e.jsx)("tr",{children:(0,e.jsx)("td",{colSpan:4,children:"Not enough data yet."})})]})]}),(0,e.jsx)("h3",{style:{marginTop:16},children:"Explain my spend"}),(0,e.jsxs)("ul",{children:[C.map((t,s)=>{if(!t||typeof t!="object")return null;let c=j.state!=="idle"||h;return(0,e.jsxs)("li",{style:{marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,e.jsxs)("span",{children:[(0,e.jsx)("b",{children:t.label||"Unknown"})," \u2014"," ",t.reason||"No reason provided",". Suggest:"," ",(0,e.jsx)("code",{children:t.action||"none"}),t.target?` (${t.target})`:""]}),(0,e.jsx)("button",{onClick:()=>_(t.action,t.target),disabled:c,style:{padding:"6px 10px",border:"1px solid #eee",borderRadius:6,cursor:c?"not-allowed":"pointer"},children:h?"Applying...":"Apply"})]},`explain-${s}-${t.action}-${t.target}`)}),!C.length&&(0,e.jsx)("li",{children:"No high-confidence suggestions yet."})]}),!!l&&(0,e.jsx)("div",{style:{marginTop:6,fontSize:12,opacity:.8,padding:"6px 12px",borderRadius:4,backgroundColor:l.includes("failed")?"#fed7d7":"#c6f6d5",border:l.includes("failed")?"1px solid #f56565":"1px solid #38a169"},children:l})]})}function $(){return(0,e.jsx)(v,{children:(0,e.jsx)(U,{})})}function i({label:r,value:o}){return(0,e.jsxs)("div",{style:{border:"1px solid #eee",borderRadius:8,padding:12},children:[(0,e.jsx)("div",{style:{fontSize:12,opacity:.7},children:r}),(0,e.jsx)("div",{style:{fontSize:20,fontWeight:600},children:o??"\u2014"})]})}function y(r){return typeof r=="number"?`$${r.toFixed(2)}`:"\u2014"}function G(r){return typeof r=="number"?`${(r*100).toFixed(2)}%`:"\u2014"}export{$ as default};
